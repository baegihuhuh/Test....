<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
body {
    max-width: 100vw;
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    touch-action: manipulation;
}

button {
    min-height: 44px;
    padding: 15px 20px;
    font-size: 16px;
    margin: 5px;
}

img {
    max-width: 100%;
    height: auto;
}

#build-version {
    position: fixed;
    right: 8px;
    bottom: 8px;
    z-index: 9999;
    font-size: 10px;
    background: rgba(0, 0, 0, 0.65);
    color: #fff;
    padding: 4px 6px;
    border-radius: 6px;
    pointer-events: none;
}

@media (max-width: 420px) {
    #build-version {
        font-size: 9px;
        right: 6px;
        bottom: 6px;
    }
}
    @keyframes bounce {
        from { transform: translateY(0); }
        to { transform: translateY(-10px); }
    }
    
    @keyframes floatUp {
        0% {
            opacity: 1;
            transform: translateY(0);
        }
        100% {
            opacity: 0;
            transform: translateY(-80px);
        }
    }
    
    .coin-effect {
        position: absolute;
        font-size: 24px;
        font-weight: bold;
        color: #ffd700;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        pointer-events: none;
        animation: floatUp 1s ease-out forwards;
        z-index: 1000;
    }
</style>
    <title>ì„¤ìœ¤ í´ë¦¬ì»¤</title>
    <style>
        /* ê³ ì–‘ì´ ìƒì  ë ˆì´ì•„ì›ƒ */
.cat-list {
    display: flex;
    gap: 10px;
    flex-wrap: wrap; 
    justify-content: center;
    margin-top: 15px;
}

/* ê³ ì–‘ì´ ë²„íŠ¼ ë””ìì¸ */
.cat-list button {
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 12px;
    cursor: pointer;
    font-size: 13px;
    font-weight: bold;
    min-width: 180px;
    box-shadow: 0 4px 0 #2e7d32;
    transition: 0.1s;
}

.cat-list button:active {
    transform: translateY(4px);
    box-shadow: none;
}

/* ëˆ ì—†ì„ ë•Œ ë²„íŠ¼ ìƒ‰ê¹” */
.cat-list button:disabled {
    background-color: #ccc;
    box-shadow: none;
    cursor: not-allowed;
}
#shop {
    position: fixed;
    bottom: 30px; /* í™”ë©´ ë°”ë‹¥ì—ì„œ 30px ìœ„ë¡œ ì˜¬ë¦¼ */
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 600px;
    background: white;
    padding: 15px;
    box-shadow: 0 -10px 30px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    align-items: center;
    max-height: 250px; /* ìƒì  ë°•ìŠ¤ ìì²´ì˜ ë†’ì´ë¥¼ ì œí•œ */
    overflow-y: auto;  /* ë²„íŠ¼ì´ ë§ìœ¼ë©´ ë°•ìŠ¤ ì•ˆì—ì„œ ìŠ¤í¬ë¡¤ */
    z-index: 1000;
    border-radius: 20px;
    border: 2px solid #ff47b6; /* ìœ„ì¹˜ í™•ì¸ìš© í…Œë‘ë¦¬ */
}

/* ê³ ì–‘ì´ ë¦¬ìŠ¤íŠ¸ëŠ” ì²˜ìŒì— ì•ˆ ë³´ì´ê²Œ ì„¤ì • */
.cat-list {
    display: none; 
    gap: 8px; /* ê°„ê²©ì„ ì‚´ì§ ì¤„ì„ */
    flex-wrap: wrap; 
    justify-content: center;
    margin-top: 10px;
    padding-bottom: 5px; /* ì•„ë˜ìª½ ë¯¸ì„¸ ì—¬ë°± */
}


#power-up-btn {
    background-color: #ff47b6;
    color: white;
    border: none;
    padding: 15px 30px;
    font-size: 18px;
    font-weight: bold;
    border-radius: 50px;
    cursor: pointer;
    transition: 0.2s;
}

#power-up-btn:hover { background-color: #e639a0; }
#power-up-btn:disabled { background-color: #ccc; cursor: not-allowed; }

#reset-btn {
    background-color: #ff5722;
    color: white;
    border: none;
    padding: 15px 30px;
    font-size: 18px;
    font-weight: bold;
    border-radius: 50px;
    cursor: pointer;
    transition: 0.2s;
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1001;
}

#reset-btn:hover { background-color: #e64a19; }

#rebirth-btn {
    background-color: #9c27b0;
    color: white;
    border: none;
    padding: 10px 20px;
    font-size: 13px;
    font-weight: bold;
    border-radius: 50px;
    cursor: pointer;
    transition: 0.2s;
    position: fixed;
    top: 75px;
    left: 270px;
    z-index: 1001;
    display: block;
    white-space: pre-line;
    line-height: 1.3;
}

#rebirth-btn:hover:not(:disabled) { background-color: #7b1fa2; }
#rebirth-btn:disabled { cursor: not-allowed; }
#reset-btn:disabled { background-color: #ccc; cursor: not-allowed; }

    body { 
        text-align: center; 
        font-family: 'Malgun Gothic', sans-serif; 
        background-color: #f0f0f0; 
        margin: 0; padding: 0;
    }

    /* ìƒë‹¨ ê²€ì€ìƒ‰ ì •ë³´ ë°” */
  #top-bar {
        background-color: #000;
        color: #fff;
        padding: 10px 15%; /* ì–‘ì˜†(15%)ì— ë„“ì€ ì—¬ë°±ì„ ì¤˜ì„œ ì •ë³´ë¥¼ ê°€ìš´ë°ë¡œ ëª¨ìŒ */
        display: flex;
        justify-content: space-between; /* ëˆê³¼ ìˆ˜ì…ì„ ì–‘ìª½ ëìœ¼ë¡œ ë°€ì–´ë‚´ë˜ ì—¬ë°± ì•ˆìœ¼ë¡œ ì œí•œ */
        align-items: center;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        position: fixed; /* í™”ë©´ ìƒë‹¨ì— ê³ ì • */
        top: 0;
        left: 0;
        right: 0;
        z-index: 100;
    }

    /* ëˆ í‘œì‹œ (ë…¸ë€ìƒ‰) */
    #money-display { 
        font-size: 24px; 
        font-weight: bold; 
        color: #ffcc00;
        min-width: 150px; /* ê¸€ìê°€ ëŠ˜ì–´ë‚˜ë„ ìœ„ì¹˜ ê³ ì • */
        text-align: left;
    }

    /* ì´ˆë‹¹ ìˆ˜ì… í‘œì‹œ (ì´ˆë¡ìƒ‰) */
    #income-display {
        font-size: 18px;
        font-weight: bold;
        color: #00ff00;
        min-width: 150px;
        text-align: right;
    }

    /* ìŒì•… ì„¤ì • íŒ¨ë„ */
    #music-control {
        position: fixed;
        top: 120px;
        left: 20px;
        background-color: rgba(0, 0, 0, 0.95);
        color: white;
        padding: 15px;
        border-radius: 10px;
        z-index: 99;
        width: 220px;
        font-size: 13px;
        display: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    }

    #music-control.show {
        display: block;
    }

    #skin-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin: 30px auto;
        flex-wrap: wrap;
    }

    #skin-control {
        background-color: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 10px 15px;
        border-radius: 10px;
        font-size: 13px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        display: none;
    }

    #skin-control.show {
        display: block;
    }

    #skin-toggle-btn {
        background-color: #673ab7;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        transition: 0.2s;
        white-space: nowrap;
    }

    #skin-toggle-btn:hover {
        background-color: #7e57c2;
    }

    #skin-control label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
    }

    .skin-buttons {
        display: flex;
        flex-direction: row;
        gap: 8px;
        align-items: center;
    }

    .skin-btn {
        padding: 8px 12px;
        background-color: #444;
        color: white;
        border: 2px solid #666;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: 0.2s;
        font-size: 12px;
        white-space: nowrap;
    }

    .skin-btn:hover {
        background-color: #555;
        border-color: #888;
    }

    .skin-btn.active {
        background-color: #ff47b6;
        border-color: #ff47b6;
    }    #music-control label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
    }

    #music-control input[type="range"] {
        width: 100%;
        margin-bottom: 10px;
        cursor: pointer;
    }

    #music-control button {
        width: 100%;
        padding: 8px;
        background-color: #ff9800;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: 0.2s;
    }

    #music-control button:hover {
        background-color: #e68900;
    }

    #settings-btn {
        position: fixed;
        top: 75px;
        left: 20px;
        background-color: #666;
        color: white;
        border: none;
        padding: 10px 12px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 18px;
        z-index: 110;
        transition: 0.2s;
    }

    #settings-btn:hover {
        background-color: #888;
    }

    #leaderboard-panel {
        position: fixed;
        top: 95px;
        right: 8px;
        width: 230px;
        background-color: rgba(0, 0, 0, 0.9);
        color: white;
        border-radius: 10px;
        padding: 10px;
        z-index: 108;
        text-align: left;
    }

    #leaderboard-panel h3 {
        margin: 0 0 8px 0;
        font-size: 16px;
    }

    #leaderboard-panel button {
        width: 100%;
        border: none;
        border-radius: 6px;
        padding: 7px;
        font-weight: bold;
        cursor: pointer;
        margin-bottom: 6px;
    }

    #refresh-board-btn { background-color: #607d8b; color: white; }

    #player-id-display {
        font-size: 13px;
        margin-bottom: 8px;
        opacity: 0.95;
    }

    #leaderboard-list {
        margin: 8px 0 0 18px;
        padding: 0;
        max-height: 180px;
        overflow-y: auto;
        font-size: 13px;
    }

    #leaderboard-status {
        font-size: 12px;
        opacity: 0.9;
        min-height: 16px;
    }

    #player-display {
        font-size: 13px;
        color: #9be7ff;
        min-width: 220px;
        text-align: center;
    }

    #logout-btn {
        background: #b71c1c;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 12px;
        cursor: pointer;
    }

    #logout-btn:hover {
        background: #d32f2f;
    }

    #login-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.65);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    }

    body.logged-in #login-overlay {
        display: none !important;
    }

    #login-modal {
        background: white;
        width: 360px;
        max-width: calc(100vw - 24px);
        box-sizing: border-box;
        border-radius: 12px;
        padding: 18px;
        text-align: left;
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
    }

    #login-modal h3 {
        margin: 0 0 10px 0;
    }

    #login-modal input {
        width: 100%;
        box-sizing: border-box;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        margin-bottom: 10px;
    }

    #login-modal button {
        width: 100%;
        padding: 10px;
        background: #3f51b5;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
    }

    #login-help {
        font-size: 12px;
        color: #555;
        margin-top: 8px;
    }

    #login-error {
        color: #d32f2f;
        font-size: 12px;
        min-height: 16px;
        margin-top: 4px;
    }

    #main-img { 
    width: 270px;
    height: 380px;
    cursor: pointer; 
    
    /* 2. ì• ë‹ˆë©”ì´ì…˜ ì„¤ì • */
    animation: floating 2s ease-in-out infinite; /* 2ì´ˆë§ˆë‹¤ ë¬´í•œ ë°˜ë³µ */
    transition: transform 0.1s;
}

#game-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 40px;
    margin-top: 180px;
}

.cat-box {
    width: 450px;
    height: 450px;
    border: 3px solid #333;
    border-radius: 10px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
    padding: 40px;
    background-color: #f9f9f9;
    align-content: center;
    justify-items: center;
}

.cat-slot {
    width: 145px;
    height: 145px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.cat-slot.locked {
    background-color: #e5e5e5;
    border: 2px dashed #999;
    color: #666;
    font-weight: bold;
    flex-direction: column;
    line-height: 1.2;
}

.cat-slot.unlocked {
    animation: bounce 0.6s infinite alternate ease-in-out;
}

.cat-slot .question {
    font-size: 38px;
}

.cat-slot .unlock-text {
    font-size: 14px;
}

#beggar-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
}#speech-bubble {
            position: absolute;
            background: #ffffff;
            border: 3px solid #000;
            border-radius: 20px;
            padding: 10px 20px;
            width: fit-content;
            top: -90px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            font-size: 18px;
            z-index: 10;
            white-space: nowrap;
            
            /* ê±°ì§€ì™€ ë˜‘ê°™ì´ ë‘¥ë‘¥ ë– ë‹¤ë‹ˆê²Œ ì„¤ì • */
            animation: floating 2s ease-in-out infinite;
        }

        /* ë§í’ì„  ê¼¬ë¦¬ ëª¨ì–‘ ë§Œë“¤ê¸° */
        #speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 15px 10px 0;
            border-style: solid;
            border-color: #000 transparent transparent;
        }

/* 3. í´ë¦­í–ˆì„ ë•Œ ì‚´ì§ ëˆŒë¦¬ëŠ” íš¨ê³¼ (ì• ë‹ˆë©”ì´ì…˜ê³¼ ê²¹ì¹˜ì§€ ì•Šê²Œ) */
#main-img:active { 
    transform: scale(0.9); 
}

/* 4. ë‘¥ë‘¥ ë– ë‹¤ë‹ˆëŠ” ì›€ì§ì„ ì •ì˜ */
@keyframes floating {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-20px); } /* ì¤‘ê°„ì— 20px ìœ„ë¡œ ì˜¬ë¼ê° */
    100% { transform: translateY(0px); }
}

/* ëª¨ë°”ì¼ ìµœì í™” */
@media (max-width: 768px) {
    #game-container {
        flex-direction: column;
        gap: 12px;
        margin-top: 88px;
    }
    
    .cat-box {
        width: 90%;
        max-width: 260px;
        height: auto;
        padding: 12px;
        gap: 10px;
        grid-template-columns: 1fr 1fr;
    }

    .cat-slot {
        width: 82px;
        height: 82px;
    }

    .cat-slot .question {
        font-size: 26px;
    }

    .cat-slot .unlock-text {
        font-size: 11px;
    }
    
    #main-img {
        width: 145px;
        height: 205px;
    }
    
    #top-bar {
        flex-wrap: wrap;
        padding: 8px;
        font-size: 11px;
        gap: 8px;
        justify-content: center;
    }
    
    #money-display {
        font-size: 15px;
        min-width: 100px;
    }
    
    #income-display {
        font-size: 12px;
        min-width: 100px;
    }
    
    #rebirth-display {
        font-size: 12px;
        min-width: 100px;
    }

    #player-display {
        font-size: 11px;
        min-width: 120px;
    }
    
    #shop {
        width: 96%;
        max-width: 430px;
        padding: 10px;
        max-height: 210px;
        bottom: 10px;
    }

    .cat-list button {
        min-width: 130px;
        font-size: 10px;
        padding: 6px 8px;
    }
    
    #leaderboard-panel {
        right: 6px;
        top: 92px;
        width: 160px;
        font-size: 10px;
        padding: 8px;
    }

    #leaderboard-panel h3 {
        font-size: 12px;
    }
    
    #settings-btn {
        top: 52px;
        left: 88px;
        font-size: 13px;
        padding: 7px 9px;
    }

    #rebirth-btn {
        top: 52px;
        left: 10px;
        font-size: 10px;
        padding: 7px 9px;
    }

    #reset-btn {
        top: 10px;
        right: 10px;
        font-size: 11px;
        padding: 7px 10px;
    }

    #speech-bubble {
        font-size: 13px;
        padding: 6px 10px;
        top: -62px;
    }
    
    .skin-btn {
        font-size: 10px;
        padding: 5px 8px;
    }

    #logout-btn {
        font-size: 11px;
        padding: 6px 8px;
    }
}

/* ëª¨ë°”ì¼ ê¸°ê¸° ì§ì ‘ ê°ì§€ ì‹œ ì¶”ê°€ ì¶•ì†Œ ë ˆì´ì•„ì›ƒ */
body.mobile #top-bar {
    padding: 8px;
    gap: 6px;
}

body.mobile #money-display {
    font-size: 16px;
    min-width: 110px;
}

body.mobile #player-display {
    min-width: 140px;
    font-size: 11px;
}

body.mobile #rebirth-display,
body.mobile #income-display {
    font-size: 12px;
    min-width: 110px;
}

body.mobile #reset-btn {
    top: 12px;
    right: 10px;
    padding: 8px 12px;
    font-size: 12px;
}

body.mobile #rebirth-btn {
    top: 56px;
    left: 10px;
    padding: 8px 12px;
    font-size: 11px;
}

body.mobile #settings-btn {
    top: 56px;
    left: 96px;
    padding: 8px 10px;
    font-size: 14px;
}

body.mobile #leaderboard-panel {
    top: 95px;
    right: 6px;
    width: 170px;
    padding: 8px;
}

body.mobile #leaderboard-panel h3 {
    font-size: 13px;
}

body.mobile #leaderboard-list,
body.mobile #player-id-display {
    font-size: 11px;
}

body.mobile #game-container {
    margin-top: 140px;
    gap: 14px;
}

body.mobile .cat-box {
    width: 92%;
    max-width: 310px;
    padding: 14px;
    gap: 14px;
}

body.mobile #main-img {
    width: 170px;
    height: 240px;
}

body.mobile #speech-bubble {
    font-size: 14px;
    padding: 8px 12px;
    top: -72px;
}

body.mobile #shop {
    width: 96%;
    max-width: 460px;
    padding: 10px;
    max-height: 220px;
    bottom: 8px;
}

body.mobile .cat-list button {
    min-width: 145px;
    font-size: 11px;
    padding: 7px 9px;
}

body.mobile #power-up-btn,
body.mobile #skin-toggle-btn,
body.mobile #logout-btn {
    font-size: 12px;
    padding: 8px 10px;
}

body.mobile #music-control {
    width: 180px;
    font-size: 11px;
    top: 100px;
    left: 8px;
    padding: 10px;
}

/* ì´ˆì†Œí˜• ëª¨ë°”ì¼(320~420px)ì—ì„œ UI ê²¹ì¹¨ ë°©ì§€ */
@media (max-width: 420px) {
    #top-bar {
        gap: 6px;
        row-gap: 4px;
        padding: 6px 8px;
    }

    #money-display,
    #income-display,
    #rebirth-display,
    #player-display {
        min-width: 0 !important;
        font-size: 11px;
    }

    #leaderboard-panel,
    body.mobile #leaderboard-panel {
        width: 140px;
        right: 4px;
        top: 90px;
    }

    #rebirth-btn,
    #settings-btn,
    #reset-btn {
        font-size: 10px;
        padding: 6px 8px;
    }

    #logout-btn {
        font-size: 10px;
        padding: 5px 7px;
    }

    #music-control,
    body.mobile #music-control {
        left: 8px;
        right: 8px;
        width: auto;
        box-sizing: border-box;
        top: 96px;
    }

    .cat-list button,
    body.mobile .cat-list button {
        min-width: 102px;
    }
}

/* ëª¨ë°”ì¼ ê°€ë¡œëª¨ë“œ ì „ìš© ë³´ì • */
@media (max-width: 900px) and (orientation: landscape) {
    #top-bar,
    body.mobile #top-bar {
        padding: 6px 10px;
        gap: 6px;
    }

    #game-container,
    body.mobile #game-container {
        margin-top: 78px;
    }

    #leaderboard-panel,
    body.mobile #leaderboard-panel {
        top: 74px;
        width: 150px;
    }

    #music-control,
    body.mobile #music-control {
        top: 78px;
        left: 8px;
        right: 8px;
        width: auto;
        max-width: 240px;
        box-sizing: border-box;
    }

    #shop,
    body.mobile #shop {
        bottom: 6px;
        max-height: 150px;
    }

    #rebirth-btn,
    #settings-btn,
    #reset-btn,
    body.mobile #rebirth-btn,
    body.mobile #settings-btn,
    body.mobile #reset-btn {
        top: 44px;
    }
}

/* ëª¨ë°”ì¼ ê°ì§€ê°€ ë¹—ë‚˜ê°€ë„ ì ìš©ë˜ëŠ” í„°ì¹˜ ê¸°ê¸° í´ë°± */
@media (hover: none) and (pointer: coarse) {
    #top-bar {
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
        padding: 8px;
    }

    #money-display,
    #income-display,
    #rebirth-display,
    #player-display {
        min-width: 0 !important;
    }

    #game-container {
        margin-top: 90px;
    }

    #shop {
        width: 96%;
        max-width: 430px;
        bottom: 10px;
    }

    #leaderboard-panel {
        right: 6px;
        top: 92px;
        width: 160px;
    }

    #settings-btn {
        top: 52px;
        left: 88px;
        font-size: 13px;
        padding: 7px 9px;
    }

    #rebirth-btn {
        top: 52px;
        left: 10px;
        font-size: 10px;
        padding: 7px 9px;
    }

    #reset-btn {
        top: 10px;
        right: 10px;
        font-size: 11px;
        padding: 7px 10px;
    }
}
</style>
</head>
<body>

<div id="build-version">build: 2026-02-18-03</div>

<div id="top-bar">
    <div id="money-display">ğŸ’° 0ì›</div>
    <div id="player-display">ìœ ì €: ë¡œê·¸ì¸ í•„ìš”</div>
    <div id="rebirth-display" style="font-size: 18px; color: #7dd3fc; min-width: 150px; font-weight: bold;"></div>
    <button id="logout-btn" onclick="logoutPlayer()">ë¡œê·¸ì•„ì›ƒ</button>
    <div id="income-display">ìˆ˜ì…: 0ì› / ì´ˆ</div>
</div>
<button id="reset-btn" onclick="resetGame()">ğŸ”„ ê²Œì„ ì´ˆê¸°í™”</button>
<button id="rebirth-btn" onclick="performRebirth()">â™»ï¸ í™˜ìƒ</button>

<!-- ì„¤ì • ë²„íŠ¼ -->
<button id="settings-btn" onclick="toggleSettings()">âš™ï¸ ì„¤ì •</button>

<!-- ìŒì•… ì œì–´ íŒ¨ë„ -->
<div id="music-control">
    <label>ğŸµ ìŒì•… ì„¤ì •</label>
    <label>BGM ë³¼ë¥¨: <span id="volume-display">10</span>%</label>
    <input type="range" id="volume-slider" min="0" max="100" value="10" oninput="changeVolume(this.value)">
    <label>íš¨ê³¼ìŒ ë³¼ë¥¨: <span id="sfx-volume-display">10</span>%</label>
    <input type="range" id="sfx-volume-slider" min="0" max="100" value="10" oninput="changeSFXVolume(this.value)">
    <button id="bgm-toggle" onclick="toggleBGM()">ğŸ”Š ìŒì•… ë„ê¸°</button>
</div>

<div id="leaderboard-panel">
    <h3>ğŸ† ë¦¬ë”ë³´ë“œ TOP 10 <span style="font-size: 12px; color: #666;">(20ì´ˆë§ˆë‹¤ ê°±ì‹ )</span></h3>
    <div id="player-id-display">ë‚´ ID: ìƒì„± ì¤‘...</div>
    <button id="refresh-board-btn" onclick="loadLeaderboard()">ìƒˆë¡œê³ ì¹¨</button>
    <div id="leaderboard-status"></div>
    <ol id="leaderboard-list"></ol>
</div>

<div id="login-overlay">
    <div id="login-modal">
        <h3>í”Œë ˆì´ì–´ ë¡œê·¸ì¸</h3>
        <input id="login-username" type="text" maxlength="16" placeholder="ìœ ì €ë„¤ì„ ì…ë ¥">
        <input id="login-password" type="password" maxlength="24" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
        <button id="login-create-btn" type="button" onclick="createAccount()">ê³„ì • ìƒì„±</button>
        <button id="login-start-btn" type="button" onclick="loginPlayer()">ë¡œê·¸ì¸</button>
        <div id="login-error"></div>
        <div id="login-help">ê³„ì • ìƒì„± í›„ ë¡œê·¸ì¸í•˜ë©´, í•´ë‹¹ ê³„ì • ì§„í–‰ ì •ë³´ê°€ ìœ ì§€ë©ë‹ˆë‹¤.</div>
    </div>
</div>

<!-- BGM -->
<audio id="bgm" loop autoplay preload="auto">
    <source src="ìŒì•….mp3" type="audio/mpeg">
</audio>

<!-- í´ë¦­ ì‚¬ìš´ë“œ -->
<audio id="coin-sound" preload="auto">
    <source src="A.mp3" type="audio/mpeg">
</audio>

<div id="game-container">
    <div id="cat-box-left" class="cat-box">
    </div>
    <div id="beggar-wrapper" style="position: relative; display: flex; flex-direction: column; align-items: center;">
        <div id="speech-bubble">í•œ í‘¼ë§Œ ì¤ì‡¼... (ëˆ ë‚´ë†”!)</div>
        <img id="main-img" src="beggar.png" onclick="addMoney()">
    </div>
    <div id="cat-box-right" class="cat-box">
    </div>
</div>

<!-- ìŠ¤í‚¨ ì„¤ì • (ë²„íŠ¼ ì˜¥ì— ê°€ë¡œë¡œ ë‚˜ì—´) -->
<div id="skin-wrapper">
    <button id="skin-toggle-btn" onclick="toggleSkinMenu()">ğŸ¨ ìºë¦­í„° ìŠ¤í‚¨ ë³€ê²½</button>
    <div id="skin-control">
        <div class="skin-buttons" id="skin-buttons-container"></div>
    </div>
</div>

<script>
const PLAYER_LIST_KEY = 'beggarPlayers';
const ACTIVE_PLAYER_KEY = 'beggarActivePlayer';
let currentPlayerId = '';
let currentUsername = '';

let money = 0;
let power = 1;
let upgradeCost = 50;
let incomePerSecond = 0;
let rebirth = 0;
const LEADERBOARD_PLAYER_ID_KEY = 'leaderboardPlayerId';
let autoSubmitTimer = null;
let lastSubmittedMoney = -1;
let lastSubmittedPlayerId = '';
let currentSkin = 'beggar';  // í˜„ì¬ ì„ íƒëœ ìŠ¤í‚¨
let saveGameTimer = null;  // ê²Œì„ ì €ì¥ íƒ€ì´ë¨¸
let sfxVolume = 0.1;  // íš¨ê³¼ìŒ ë³¼ë¥¨ (0.0 ~ 1.0)

function detectMobileDevice() {
    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    const userAgent = navigator.userAgent || '';
    const isMobileUA = /Android|iPhone|iPad|iPod|Windows Phone|webOS|BlackBerry|Opera Mini|IEMobile/i.test(userAgent);
    const isSmallViewport = window.matchMedia('(max-width: 900px)').matches;
    return isSmallViewport || isMobileUA || isTouchDevice;
}

function applyMobileLayoutClass() {
    document.body.classList.toggle('mobile', detectMobileDevice());
}

window.addEventListener('resize', applyMobileLayoutClass);
window.addEventListener('orientationchange', applyMobileLayoutClass);
document.addEventListener('DOMContentLoaded', applyMobileLayoutClass);
applyMobileLayoutClass();

// ì„œë²„ì— ê²Œì„ ì„¸ì´ë¸Œ ì €ì¥
async function saveGameToServer() {
    if (!currentUsername) return;

    const gameState = {
        money: money,
        power: power,
        upgradeCost: upgradeCost,
        incomePerSecond: incomePerSecond,
        rebirth: rebirth,
        catData: catData
    };

    console.log('ğŸ’¾ ì„œë²„ì— ì €ì¥:', gameState);

    try {
        await requestAPI(`/api/accounts/${encodeURIComponent(currentUsername)}/save`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ gameData: gameState })
        });
    } catch (error) {
        console.error('ê²Œì„ ì €ì¥ ì‹¤íŒ¨:', error);
    }
}

// ê²Œì„ ì €ì¥ ë””ë°”ìš´ìŠ¤ (ë§¤ë²ˆ updateUIë§ˆë‹¤ ì €ì¥í•˜ì§€ ì•Šê³  2ì´ˆë§ˆë‹¤ í•œ ë²ˆì”©)
function scheduleSaveGame() {
    if (!currentUsername) return;
    
    if (saveGameTimer) {
        clearTimeout(saveGameTimer);
    }
    
    saveGameTimer = setTimeout(() => {
        saveGameToServer();
    }, 2000);
}

// ìŠ¤í‚¨ ë°ì´í„°
const skinData = {
    'beggar': { name: 'ê¸°ë³¸ ê±°ì§€', file: 'beggar.png' },
    'sullyoon1': { name: 'ì„¤ìœ¤ ìŠ¤í‚¨ 1', file: 'ì„¤ìœ¤1.png' },
    'sullyoon2': { name: 'ì„¤ìœ¤ ìŠ¤í‚¨ 2', file: 'ì„¤ìœ¤2.png' },
    'sullyoon3': { name: 'ì„¤ìœ¤ ìŠ¤í‚¨ 3', file: 'ì„¤ìœ¤3.png' },
    'sullyoon4': { name: 'ì„¤ìœ¤ ìŠ¤í‚¨ 4', file: 'ì„¤ìœ¤4.png' },
    'sullyoon5': { name: 'ì„¤ìœ¤ ìŠ¤í‚¨ 5', file: 'ì„¤ìœ¤5.png' },
    'sullyoon6': { name: 'ì„¤ìœ¤ ìŠ¤í‚¨ 6', file: 'ì„¤ìœ¤6.png' }
};

function getSaveKey() {
    return currentPlayerId ? `beggarGameSave_${currentPlayerId}` : 'beggarGameSave';
}

function normalizeUsername(value) {
    return (value || '')
        .replace(/[\u200B-\u200D\uFEFF]/g, '')
        .trim();
}

function normalizePassword(value) {
    return String(value || '').trim();
}

async function requestAPI(path, options = {}) {
    const bases = location.port === '3000'
        ? ['']
        : ['http://localhost:3000', 'http://127.0.0.1:3000'];

    let lastError = null;

    for (const base of bases) {
        try {
            const response = await fetch(`${base}${path}`, options);
            return response;
        } catch (error) {
            lastError = error;
        }
    }

    throw lastError || new Error('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
}



    // ê³ ì–‘ì´ ë°ì´í„° (owned ì†ì„± ì¶”ê°€ë¡œ ì¤‘ë³µ êµ¬ë§¤ ë°©ì§€)
    const catData = {
        'korshort': { name: 'ì½”ìˆ', cost: 50, income: 1, owned: false },
        'persian': { name: 'í˜ë¥´ì‹œì•ˆ', cost: 200, income: 5, owned: false },
        'russian': { name: 'ëŸ¬ì‹œì•ˆ ë¸”ë£¨', cost: 1000, income: 30, owned: false },
        'siamese': { name: 'ìƒ´', cost: 5000, income: 150, owned: false },
        'munchkin': { name: 'ë¨¼ì¹˜í‚¨', cost: 20000, income: 700, owned: false },
        'maincoon': { name: 'ë©”ì¸ì¿¤', cost: 100000, income: 4000, owned: false },
        'ragdoll': { name: 'ë™ëŒ', cost: 1000000, income: 50000, owned: false }
    };

    function applyPlayerGameData(data) {
        console.log('ğŸ“¦ ê²Œì„ ë°ì´í„° ì ìš© ì‹œì‘:', data);
        
        money = 0;
        power = 1;
        upgradeCost = 50;
        incomePerSecond = 0;
        rebirth = 0;

        for (let key in catData) {
            catData[key].owned = false;
        }

        if (!data) {
            console.log('âš ï¸ ë°ì´í„° ì—†ìŒ - ì´ˆê¸°í™” ìƒíƒœ ìœ ì§€');
            return;
        }

        money = Number(data.money) || 0;
        power = Number(data.power) || 1;
        upgradeCost = Number(data.upgradeCost) || 50;
        incomePerSecond = Number(data.incomePerSecond) || 0;
        rebirth = Number(data.rebirth) || 0;
        
        console.log(`âœ… ë°ì´í„° ì ìš© ì™„ë£Œ - ëˆ: ${money.toLocaleString()}, íŒŒì›Œ: ${power}, í™˜ìƒ: ${rebirth}`);

        if (data.catData) {
            for (let key in catData) {
                if (data.catData[key]) {
                    catData[key].owned = !!data.catData[key].owned;
                }
            }
        }
    }

    async function loadCurrentPlayerGame() {
        if (!currentUsername) {
            console.log('âš ï¸ ë¡œê·¸ì¸ ì•ˆë¨ - ë°ì´í„° ì´ˆê¸°í™”');
            applyPlayerGameData(null);
            return;
        }

        console.log(`ğŸ“š ì„œë²„ì—ì„œ ê²Œì„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°: ${currentUsername}`);
        try {
            const response = await requestAPI(`/api/accounts/${encodeURIComponent(currentUsername)}/save`);
            if (response.ok) {
                const result = await response.json();
                console.log('âœ… ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°:', result.gameData);
                applyPlayerGameData(result.gameData);
            } else {
                console.error('âŒ ì„œë²„ ì‘ëŠµ ì˜¤ë¥˜:', response.status);
                applyPlayerGameData(null);
            }
        } catch (e) {
            console.error('ê²Œì„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
            applyPlayerGameData(null);
        }
    }

    function hideLoginOverlay() {
        const overlayEl = document.getElementById('login-overlay');
        if (!overlayEl) return;

        document.body.classList.add('logged-in');
        overlayEl.style.display = 'none';
        overlayEl.style.pointerEvents = 'none';
        overlayEl.hidden = true;
    }

    // ìŠ¤í‚¨ ì„ íƒ í•¨ìˆ˜
    function selectSkin(skinKey) {
        currentSkin = skinKey;
        // localStorageì— ì €ì¥
        localStorage.setItem('selectedSkin', skinKey);
        // ì´ë¯¸ì§€ ë³€ê²½
        updateSkinImage();
        // UI ì—…ë°ì´íŠ¸
        updateSkinButtonUI();
    }

    // ìŠ¤í‚¨ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
    function updateSkinImage() {
        const img = document.getElementById('main-img');
        const bubble = document.getElementById('speech-bubble');
        const skin = skinData[currentSkin];
        
        if (img && skin) {
            img.src = skin.file;
        }
        
        // ë§í’ì„  í…ìŠ¤íŠ¸ ë³€ê²½
        if (bubble) {
            if (currentSkin === 'beggar') {
                bubble.innerText = 'í•œ í‘¼ë§Œ ì¤ì‡¼... (ëˆ ë‚´ë†”!)';
            } else {
                bubble.innerText = 'ëˆ ë‚´ë†” !';
            }
        }
    }

    // ìŠ¤í‚¨ ë²„íŠ¼ UI ì—…ë°ì´íŠ¸
    function updateSkinButtonUI() {
        const buttons = document.querySelectorAll('.skin-btn');
        buttons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.skin === currentSkin) {
                btn.classList.add('active');
            }
        });
    }

    // ì €ì¥ëœ ìŠ¤í‚¨ ë¡œë“œ
    function loadSavedSkin() {
        const saved = localStorage.getItem('selectedSkin');
        if (saved && skinData[saved]) {
            currentSkin = saved;
        }
        updateSkinImage();
    }

    // ìŠ¤í‚¨ ì„ íƒ UI ì´ˆê¸°í™”
    function initializeSkinUI() {
        const container = document.getElementById('skin-buttons-container');
        if (!container) return;

        container.innerHTML = '';
        for (const [key, skin] of Object.entries(skinData)) {
            const btn = document.createElement('button');
            btn.className = 'skin-btn';
            btn.dataset.skin = key;
            btn.innerText = skin.name;
            btn.onclick = () => selectSkin(key);
            container.appendChild(btn);
        }

        updateSkinButtonUI();
    }

    function showLoginOverlay() {
        const overlayEl = document.getElementById('login-overlay');
        if (!overlayEl) return;

        document.body.classList.remove('logged-in');
        overlayEl.hidden = false;
        overlayEl.style.display = 'flex';
        overlayEl.style.pointerEvents = 'auto';
    }

    async function loginPlayer() {
        const usernameInput = document.getElementById('login-username');
        const passwordInput = document.getElementById('login-password');
        const errorEl = document.getElementById('login-error');
        usernameInput.blur();
        passwordInput.blur();

        const rawUsername = String(usernameInput.value || '');
        const username = normalizeUsername(rawUsername);
        const password = normalizePassword(passwordInput.value);

        errorEl.innerText = '';

        if (!username || !password) {
            errorEl.innerText = 'ìœ ì €ë„¤ì„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            usernameInput.focus();
            return;
        }

        errorEl.innerText = 'ë¡œê·¸ì¸ ì¤‘...';

        try {
            const response = await requestAPI('/api/accounts/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            const result = await response.json();

            if (!response.ok) {
                errorEl.innerText = result.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨';
                return;
            }

            currentPlayerId = result.account.id;
            currentUsername = result.account.username;
            localStorage.setItem(ACTIVE_PLAYER_KEY, JSON.stringify({ id: currentPlayerId, username: currentUsername }));

            document.getElementById('player-display').innerText = `ìœ ì €: ${currentUsername} (${currentPlayerId})`;
            document.getElementById('player-id-display').innerText = `ë‚´ ID: ${currentUsername}#${currentPlayerId}`;
            hideLoginOverlay();

            // ì„œë²„ì—ì„œ ê²Œì„ ë°ì´í„° ë¡œë“œ
            applyPlayerGameData(result.account.gameData);
            loadSavedSkin();
            updateUI();
            loadLeaderboard();
            startAutoLeaderboardSync();
        } catch (error) {
            errorEl.innerText = 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨: npm.cmd start ì‹¤í–‰ í•„ìš”';
            console.error('ë¡œê·¸ì¸ ì—ëŸ¬:', error);
        }
    }

    async function createAccount() {
        const usernameInput = document.getElementById('login-username');
        const passwordInput = document.getElementById('login-password');
        const errorEl = document.getElementById('login-error');

        const username = normalizeUsername(usernameInput.value);
        const password = normalizePassword(passwordInput.value);

        errorEl.innerText = '';

        if (!username || !password) {
            errorEl.innerText = 'ìœ ì €ë„¤ì„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            return;
        }

        errorEl.innerText = 'ê³„ì • ìƒì„± ì¤‘...';

        try {
            const response = await requestAPI('/api/accounts/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            const result = await response.json();

            if (!response.ok) {
                errorEl.style.color = '#d32f2f';
                errorEl.innerText = result.message || 'ê³„ì • ìƒì„± ì‹¤íŒ¨';
                return;
            }

            errorEl.style.color = '#2e7d32';
            errorEl.innerText = `ê³„ì • ìƒì„± ì™„ë£Œ! ID: ${result.account.id} / ì´ì œ ë¡œê·¸ì¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`;
        } catch (error) {
            errorEl.style.color = '#d32f2f';
            errorEl.innerText = 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨: npm.cmd start ì‹¤í–‰ í•„ìš”';
            console.error('ê³„ì • ìƒì„± ì—ëŸ¬:', error);
        }
    }

    function logoutPlayer() {
        if (!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        localStorage.removeItem(ACTIVE_PLAYER_KEY);

        currentPlayerId = '';
        currentUsername = '';
        lastSubmittedMoney = -1;
        lastSubmittedPlayerId = '';

        if (autoSubmitTimer) {
            clearInterval(autoSubmitTimer);
            autoSubmitTimer = null;
        }

        document.getElementById('player-display').innerText = 'ìœ ì €: ë¡œê·¸ì¸ í•„ìš”';
        document.getElementById('player-id-display').innerText = 'ë‚´ ID: ë¡œê·¸ì¸ í•„ìš”';
        document.getElementById('leaderboard-status').innerText = 'ë¡œê·¸ì•„ì›ƒë¨';

        applyPlayerGameData(null);
        updateUI();
        showLoginOverlay();
        document.getElementById('login-username').focus();
    }

    async function restoreActivePlayerSession() {
        console.log('ğŸ”„ ì„¸ì…˜ ë³µì› ì‹œë„...');
        try {
            const raw = localStorage.getItem(ACTIVE_PLAYER_KEY);
            if (!raw) {
                console.log('âš ï¸ localStorageì— ì„¸ì…˜ ì—†ìŒ');
                return;
            }
            const parsed = JSON.parse(raw);
            if (!parsed || !parsed.id || !parsed.username) {
                console.log('âš ï¸ ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ ë°ì´í„°');
                return;
            }

            currentPlayerId = parsed.id;
            currentUsername = parsed.username;
            console.log(`âœ… ì„¸ì…˜ ë³µì›: ${currentUsername} (${currentPlayerId})`);

            hideLoginOverlay();

            document.getElementById('player-display').innerText = `ìœ ì €: ${currentUsername} (${currentPlayerId})`;
            document.getElementById('player-id-display').innerText = `ë‚´ ID: ${currentUsername}#${currentPlayerId}`;

            await loadCurrentPlayerGame();
            loadSavedSkin();  // ì €ì¥ëœ ìŠ¤í‚¨ ë¡œë“œ
            updateUI();
            startAutoLeaderboardSync();
        } catch (e) {
            console.error('âŒ ì„¸ì…˜ ë³µêµ¬ ì—ëŸ¬:', e);
        }
    }


    function addMoney() {
        money += power;
        
        // ì½”ì¸ ì‚¬ìš´ë“œ ì¬ìƒ
        const coinSound = document.getElementById('coin-sound');
        if (coinSound) {
            coinSound.currentTime = 0;
            coinSound.volume = sfxVolume;
            coinSound.play().catch(err => {
                console.error('ì½”ì¸ ì‚¬ìš´ë“œ ì¬ìƒ ì˜¤ë¥˜:', err);
            });
        } else {
            console.error('coin-sound ì˜¤ë””ì˜¤ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        // ì‹œê° íš¨ê³¼ (ì½”ì¸ì´ ìœ„ë¡œ ì˜¬ë¼ê°€ëŠ” íš¨ê³¼)
        createCoinEffect();
        
        updateUI();
    }
    
    function createCoinEffect() {
        const wrapper = document.getElementById('beggar-wrapper');
        if (!wrapper) return;
        
        const effect = document.createElement('div');
        effect.className = 'coin-effect';
        effect.innerText = `+${power.toLocaleString()}ì›`;
        
        // ëœë¤ ìœ„ì¹˜ (ê±°ì§€ ì£¼ë³€)
        const randomX = (Math.random() - 0.5) * 100;
        effect.style.left = `calc(50% + ${randomX}px)`;
        effect.style.top = '50%';
        
        wrapper.appendChild(effect);
        
        // 1ì´ˆ í›„ ì œê±°
        setTimeout(() => {
            effect.remove();
        }, 1000);
    }

    function checkRebirthCondition() {
        // ëª¨ë“  ê³ ì–‘ì´ê°€ ë³´ìœ ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        const allCatsOwned = Object.values(catData).every(cat => cat.owned);
        // í™˜ìƒ íšŸìˆ˜ì— ë”°ë¼ í•„ìš” ê¸ˆì•¡ ì¦ê°€ (1íšŒì°¨: 1000ë§Œ, 2íšŒì°¨: 2000ë§Œ, 3íšŒì°¨: 3000ë§Œ...)
        const requiredMoney = 10000000 * (rebirth + 1);
        const hasEnoughMoney = money >= requiredMoney;
        return allCatsOwned && hasEnoughMoney;
    }

    function getRebirthStatus() {
        const ownedCats = Object.values(catData).filter(cat => cat.owned).length;
        const totalCats = Object.keys(catData).length;
        const requiredMoney = 10000000 * (rebirth + 1);
        return {
            money: money,
            moneyRequired: requiredMoney,
            catsOwned: ownedCats,
            totalCats: totalCats,
            canRebirth: checkRebirthCondition()
        };
    }

    function performRebirth() {
        if (!checkRebirthCondition()) {
            const requiredMoney = 10000000 * (rebirth + 1);
            alert(`í™˜ìƒ ì¡°ê±´ì„ ë§Œì¡±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\ní•„ìš” ê³¨ë“œ: ${requiredMoney.toLocaleString()}ì› (í˜„ì¬: ${money.toLocaleString()}ì›)\ní•„ìš” ê³ ì–‘ì´: 7ë§ˆë¦¬ (ëª¨ë‘ ë³´ìœ í•´ì•¼ í•¨)`);
            return;
        }

        if (!confirm(`ì •ë§ í™˜ìƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní˜„ì¬ í™˜ìƒ íšŸìˆ˜: ${rebirth}íšŒ\ní™˜ìƒ í›„ í´ë¦­ë ¥: ${(1 + (rebirth + 1) * 0.15).toFixed(2)}ë°°`)) {
            return;
        }

        // í™˜ìƒ íšŸìˆ˜ ì¦ê°€
        rebirth++;
        
        // í´ë¦­ íŒŒì›Œ ëˆ„ì  (ê¸°ë³¸ 1 + í™˜ìƒíšŸìˆ˜ Ã— 0.15)
        power = 1 + (rebirth * 0.15);
        
        // ë‚˜ë¨¸ì§€ëŠ” ì´ˆê¸°í™”
        money = 0;
        upgradeCost = 50;
        incomePerSecond = 0;

        // ê³ ì–‘ì´ ì´ˆê¸°í™”
        for (let key in catData) {
            catData[key].owned = false;
        }

        // ê²Œì„ ìƒíƒœ ì €ì¥ ë° UI ì—…ë°ì´íŠ¸ (ìŒì•… ìœ ì§€)
        const gameState = {
            money: money,
            power: power,
            upgradeCost: upgradeCost,
            incomePerSecond: incomePerSecond,
            rebirth: rebirth,
            catData: catData
        };
        if (currentPlayerId) {
            localStorage.setItem(getSaveKey(), JSON.stringify(gameState));
        }
        
        updateUI();
        
        // í™˜ìƒ ì •ë³´ë¥¼ ì„œë²„ì— ì „ì†¡ë§Œ (ë¦¬ë”ë³´ë“œ ìë™ ìƒˆë¡œê³ ì¹¨ ì œê±°)
        setTimeout(async () => {
            await submitScore(true);
        }, 300);
    }

    function toggleSettings() {
        const musicPanel = document.getElementById('music-control');
        musicPanel.classList.toggle('show');
    }

    function toggleSkinMenu() {
        const skinPanel = document.getElementById('skin-control');
        if (skinPanel.style.display === 'none' || skinPanel.style.display === '') {
            skinPanel.style.display = 'block';
        } else {
            skinPanel.style.display = 'none';
        }
    }

    function changeVolume(value) {
        const bgm = document.getElementById('bgm');
        bgm.volume = value / 1000;  // 0~100 ë²”ìœ„ â†’ 0~0.1(10%) ìŒëŸ‰
        document.getElementById('volume-display').innerText = value;
        localStorage.setItem('bgmVolume', value);
    }

    function changeSFXVolume(value) {
        sfxVolume = value / 100;  // 0~100 ë²”ìœ„ â†’ 0~1.0 ìŒëŸ‰
        document.getElementById('sfx-volume-display').innerText = value;
        localStorage.setItem('sfxVolume', value);
    }

    function toggleBGM() {
        const bgm = document.getElementById('bgm');
        const btn = document.getElementById('bgm-toggle');
        
        if (bgm.paused) {
            isBgmManuallyPaused = false;
            bgm.play().then(() => {
                btn.textContent = 'ğŸ”Š ìŒì•… ë„ê¸°';
            }).catch(() => {
                btn.textContent = 'ğŸ”‡ ìŒì•… ì¼œê¸°';
            });
        } else {
            isBgmManuallyPaused = true;
            bgm.pause();
            btn.textContent = 'ğŸ”‡ ìŒì•… ì¼œê¸°';
        }
    }

    async function submitScore(silent = false) {
        const statusEl = document.getElementById('leaderboard-status');

        if (!silent) statusEl.innerText = 'ë“±ë¡ ì¤‘...';

        try {
            const response = await requestAPI('/api/leaderboard', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    name: `${currentUsername}#${currentPlayerId}`, 
                    money,
                    rebirth
                })
            });

            lastSubmittedMoney = money;
            lastSubmittedPlayerId = currentPlayerId;

            if (!silent) statusEl.innerText = 'ì ìˆ˜ ë“±ë¡ ì™„ë£Œ!';
            await loadLeaderboard(silent);
        } catch (error) {
            if (!silent) statusEl.innerText = 'ë“±ë¡ ì‹¤íŒ¨: ì„œë²„ ì‹¤í–‰ í™•ì¸ (npm.cmd start)';
        }
    }

    async function loadLeaderboard(silent = false) {
        const listEl = document.getElementById('leaderboard-list');
        const statusEl = document.getElementById('leaderboard-status');
        if (!silent) statusEl.innerText = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

        try {
            const response = await requestAPI('/api/leaderboard');

            const ranking = await response.json();
            console.log('ë¦¬ë”ë³´ë“œ ë°ì´í„°:', ranking);
            listEl.innerHTML = '';

            if (!ranking.length) {
                if (!silent) statusEl.innerText = 'ë“±ë¡ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.';
                return;
            }

            ranking.forEach((item, index) => {
                const li = document.createElement('li');
                console.log(`${index + 1}ë²ˆì§¸ í•­ëª©:`, item.name, 'rebirth:', item.rebirth, 'íƒ€ì…:', typeof item.rebirth);
                const rebirthText = item.rebirth && item.rebirth > 0 ? `[í™˜ìƒÃ—${item.rebirth}] ` : '';
                li.innerText = `${index + 1}. ${rebirthText}${item.name} - ${Number(item.money).toLocaleString()}ì›`;
                listEl.appendChild(li);
            });

            if (!silent) statusEl.innerText = `ì—…ë°ì´íŠ¸ ì™„ë£Œ (${ranking.length}ëª…)`;
        } catch (error) {
            if (!silent) statusEl.innerText = 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨: npm.cmd start ì‹¤í–‰ í•„ìš”';
            console.error('ë¦¬ë”ë³´ë“œ ë¡œë“œ ì—ëŸ¬:', error);
        }
    }

    function startAutoLeaderboardSync() {
        if (autoSubmitTimer) clearInterval(autoSubmitTimer);

        autoSubmitTimer = setInterval(async () => {
            if (!currentPlayerId) return;
            if (currentPlayerId === lastSubmittedPlayerId && money === lastSubmittedMoney) return;
            await submitScore(true);
        }, 20000);  // 20ì´ˆë§ˆë‹¤

        // ì´ˆê¸° ì ìˆ˜ ì œì¶œë§Œ ìˆ˜í–‰
        if (lastSubmittedPlayerId !== currentPlayerId) {
            submitScore(true);
        }
        // ë¦¬ë”ë³´ë“œëŠ” ì²˜ìŒ ë¡œê·¸ì¸í•  ë•Œë§Œ ë¡œë“œ (ìë™ ìƒˆë¡œê³ ì¹¨ ì œê±°)
    }

    function upgradePower() {
        if (money >= upgradeCost) {
            money -= upgradeCost;
            power += 3;
            upgradeCost = Math.floor(upgradeCost * 1.5);
            updateUI();
        } else {
            alert("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤!");
        }
    }

    function resetGame() {
        if (confirm("ì •ë§ë¡œ ê²Œì„ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ì§„í–‰ ìƒí™©ì´ ì‚­ì œë©ë‹ˆë‹¤.")) {
            // ë³€ìˆ˜ ì´ˆê¸°í™”
            money = 0;
            power = 1;
            upgradeCost = 50;
            incomePerSecond = 0;
            rebirth = 0;
            
            // ê³ ì–‘ì´ ë°ì´í„° ì´ˆê¸°í™”
            for (let key in catData) {
                catData[key].owned = false;
            }
            
            // ê³ ì–‘ì´ ë°•ìŠ¤ ì´ˆê¸°í™”
            document.getElementById('cat-box-left').innerHTML = '';
            document.getElementById('cat-box-right').innerHTML = '';
            
            // localStorage ì´ˆê¸°í™” (ì„œë²„ëŠ” ì´ˆê¸°í™” ì•ˆí•¨)
            // localStorage.removeItem(getSaveKey());
            
            // ìŒì•… ì¬ì‹œì‘
            const bgm = document.getElementById('bgm');
            bgm.currentTime = 0;
            bgm.volume = 0.01;  // 10% ê¸°ë³¸ê°’
            bgm.play();
            
            // ë³¼ë¥¨ ìŠ¬ë¼ì´ë” ì´ˆê¸°í™”
            document.getElementById('volume-slider').value = 10;
            document.getElementById('volume-display').innerText = '10';
            document.getElementById('bgm-toggle').textContent = 'ğŸ”Š ìŒì•… ë„ê¸°';
            
            // UI ì—…ë°ì´íŠ¸
            updateUI();
            
            alert("ê²Œì„ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!");
        }
    }

    function buyCat(type) {

        const cat = catData[type];
        if (cat.owned) return; // ì´ë¯¸ ìƒ€ìœ¼ë©´ ì•„ë¬´ ì¼ë„ ì•ˆ í•¨

        if (money >= cat.cost) {
            money -= cat.cost;
            cat.owned = true; // ê³ ìš© ìƒíƒœë¡œ ë³€ê²½
            incomePerSecond += cat.income;
            updateUI();
        } else {
            alert("ëˆì´ ë¶€ì¡±í•´ìš”!");
        }
    }

    function toggleCatList() {
        const list = document.getElementById('cat-list-container');
        const btn = document.getElementById('toggle-cat-btn');
        if (list.style.display === "none" || list.style.display === "") {
            list.style.display = "flex";
            btn.innerText = "âŒ ë‹«ê¸°";
        } else {
            list.style.display = "none";
            btn.innerText = "ğŸ¾ ì•Œë°”ìƒ ê³ ìš©í•˜ê¸°";
        }
    }

    function updateUI() {
        document.getElementById('money-display').innerText = "ğŸ’° " + money.toLocaleString() + "ì›";
        let incomeText = "ìˆ˜ì…: " + incomePerSecond.toLocaleString() + "ì› / ì´ˆ";
        if (rebirth > 0) {
            incomeText += ` [í™˜ìƒ Ã—${rebirth}]`;
        }
        document.getElementById('income-display').innerText = incomeText;
        
        // í™˜ìƒ ì •ë³´ í‘œì‹œ
        const rebirthDisplay = document.getElementById('rebirth-display');
        if (currentPlayerId) {
            const currentBoost = (1 + (rebirth * 0.15)).toFixed(2);
            rebirthDisplay.innerText = `â™»ï¸ í™˜ìƒ Ã—${rebirth} (í´ë¦­ë ¥: ${currentBoost}ë°°)`;
        } else {
            rebirthDisplay.innerText = '';
        }
        
        // í™˜ìƒ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        const rebirthBtn = document.getElementById('rebirth-btn');
        if (rebirthBtn) {
            const status = getRebirthStatus();
            let btnText = 'â™»ï¸ í™˜ìƒ';
            btnText += `\nê³¨ë“œ: ${(Math.floor(money / 10000)).toLocaleString()}ë§Œ / ${Math.floor(status.moneyRequired / 10000).toLocaleString()}ë§Œ`;
            btnText += `\nê³ ì–‘ì´: ${status.catsOwned}/${status.totalCats}`;
            rebirthBtn.innerText = btnText;
            rebirthBtn.disabled = !status.canRebirth;
            rebirthBtn.style.opacity = status.canRebirth ? '1' : '0.6';
        }
        
        const upgradeCostEl = document.getElementById('upgrade-cost');
        const powerUpBtnEl = document.getElementById('power-up-btn');
        if (upgradeCostEl) {
            upgradeCostEl.innerText = upgradeCost.toLocaleString();
        }
        if (powerUpBtnEl) {
            powerUpBtnEl.disabled = (money < upgradeCost);
        }

        // ê³ ì–‘ì´ ë²„íŠ¼ë“¤ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì •ë³´ í‘œì‹œ ë° ì¤‘ë³µ ë°©ì§€)
        for (let key in catData) {
            const cat = catData[key];
            const btn = document.getElementById('btn-' + key);
            if (btn) {
                if (cat.owned) {
                    btn.innerText = `âœ… ${cat.name} (ê³ ìš©ë¨)`;
                    btn.style.backgroundColor = "#888"; // íšŒìƒ‰ìœ¼ë¡œ ë³€ê²½
                    btn.disabled = true;
                } else {
                    btn.innerText = `ğŸ¾ ${cat.name} (${cat.cost.toLocaleString()}ì› | +${cat.income}/ì´ˆ)`;
                    btn.disabled = (money < cat.cost);
                }
            }
        }

        renderCatBoxes();

        // ê²Œì„ ì„¸ì´ë¸Œë¥¼ ì„œë²„ì— ì €ì¥ (ë””ë°”ìš´ìŠ¤ ì ìš©)
        scheduleSaveGame();
    }

    setInterval(function() {
        if (incomePerSecond > 0) {
            money += incomePerSecond;
            updateUI();
        }
    }, 1000);

    // ë¶€ì •í–‰ìœ„ ê°ì§€: ë¹„ì •ìƒì ì¸ ëˆ ì¦ê°€ ê°ì‹œ
    let lastCheckedMoney = 0;
    let lastCheckTime = Date.now();
    
    setInterval(() => {
        if (!currentPlayerId) return;
        
        const now = Date.now();
        const timeDiff = (now - lastCheckTime) / 1000; // ì´ˆ ë‹¨ìœ„
        const moneyDiff = money - lastCheckedMoney;
        
        // í•©ë¦¬ì  í•œê³„: ì´ˆë‹¹ ìµœëŒ€ 200000ì› (ê³ ì–‘ì´ ìµœëŒ€ + í´ë¦­)
        const maxReasonablePerSecond = 200000;
        const maxReasonable = maxReasonablePerSecond * timeDiff * 1.5;
        
        if (moneyDiff > maxReasonable && moneyDiff > 100000000) {
            // ë¹„ì •ìƒ ê°ì§€ ì‹œ ê²½ê³ 
            console.warn('âš ï¸ ë¹„ì •ìƒì ì¸ ëˆ ì¦ê°€ ê°ì§€ë¨. ì„œë²„ì—ì„œ ê±°ë¶€ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', moneyDiff);
        }
        
        lastCheckedMoney = money;
        lastCheckTime = now;
    }, 10000);
    // ë¡œê·¸ì¸ ì „ì—ëŠ” ì˜¤ë²„ë ˆì´ë§Œ ë³´ì—¬ì£¼ê³ , ë¡œê·¸ì¸ í›„ updateUIê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.
// ìŒì•… ìŒëŸ‰ ì„¤ì •
const bgm = document.getElementById('bgm');
let isBgmManuallyPaused = false;

// BGM ë³¼ë¥¨ ì´ˆê¸°í™” (localStorageì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°)
const savedBgmVolume = localStorage.getItem('bgmVolume') || '10';
bgm.volume = savedBgmVolume / 1000;
document.getElementById('volume-slider').value = savedBgmVolume;
document.getElementById('volume-display').innerText = savedBgmVolume;

// íš¨ê³¼ìŒ ë³¼ë¥¨ ì´ˆê¸°í™” (localStorageì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°)
const savedSfxVolume = localStorage.getItem('sfxVolume') || '10';
sfxVolume = savedSfxVolume / 100;
document.getElementById('sfx-volume-slider').value = savedSfxVolume;
document.getElementById('sfx-volume-display').innerText = savedSfxVolume;

bgm.muted = false;

function tryPlayBGM() {
    bgm.play().then(() => {
        const toggleBtn = document.getElementById('bgm-toggle');
        if (toggleBtn) toggleBtn.textContent = 'ğŸ”Š ìŒì•… ë„ê¸°';
    }).catch(() => {
    });
}

tryPlayBGM();

function ensureBgmPlaying() {
    if (isBgmManuallyPaused) return;
    if (document.hidden) return;
    if (bgm.paused) {
        tryPlayBGM();
    }
}

const unlockBgmOnGesture = () => {
    tryPlayBGM();
    window.removeEventListener('pointerdown', unlockBgmOnGesture);
    window.removeEventListener('keydown', unlockBgmOnGesture);
    window.removeEventListener('touchstart', unlockBgmOnGesture);
};

window.addEventListener('pointerdown', unlockBgmOnGesture, { once: true });
window.addEventListener('keydown', unlockBgmOnGesture, { once: true });
window.addEventListener('touchstart', unlockBgmOnGesture, { once: true });
window.addEventListener('focus', ensureBgmPlaying);
document.addEventListener('visibilitychange', ensureBgmPlaying);
bgm.addEventListener('pause', () => {
    setTimeout(ensureBgmPlaying, 200);
});
setInterval(ensureBgmPlaying, 3000);

document.getElementById('login-username').addEventListener('keydown', (event) => {
    if (event.isComposing) return;
    if (event.key === 'Enter') {
        loginPlayer();
    }
});

document.getElementById('login-password').addEventListener('keydown', (event) => {
    if (event.isComposing) return;
    if (event.key === 'Enter') {
        loginPlayer();
    }
});

window.loginPlayer = loginPlayer;
window.createAccount = createAccount;
window.logoutPlayer = logoutPlayer;
window.performRebirth = performRebirth;
restoreActivePlayerSession();

// í˜ì´ì§€ ë¡œë“œ í›„ ìŒì•… ë³¼ë¥¨ ìµœì¢… í™•ì • (ë²„ê·¸ ë°©ì§€)
window.addEventListener('load', () => {
    const bgm = document.getElementById('bgm');
    bgm.volume = 0.01;  // 10% ê¸°ë³¸ê°’
    document.getElementById('volume-slider').value = 10;
    
    // ìŠ¤í‚¨ UI ì´ˆê¸°í™”
    initializeSkinUI();
    loadSavedSkin();
});

setInterval(() => {
    if (currentPlayerId) {
        hideLoginOverlay();
    }
}, 1000);

    
    // ê³ ì–‘ì´ ë°•ìŠ¤ ë Œë”ë§ í•¨ìˆ˜ (ë¯¸êµ¬ë§¤ëŠ” ? UNLOCK í‘œì‹œ)
    function renderCatBoxes() {
        const leftBox = document.getElementById('cat-box-left');
        const rightBox = document.getElementById('cat-box-right');
        if (!leftBox || !rightBox) return;

        leftBox.innerHTML = '';
        rightBox.innerHTML = '';

        const leftBoxCats = ['korshort', 'persian', 'russian'];
        const rightBoxCats = ['siamese', 'munchkin', 'maincoon', 'ragdoll'];

        const catImages = {
            'korshort': 'ì½”ìˆ.png',
            'persian': 'í˜ë¥´ì‹œì•ˆ.png',
            'russian': 'ëŸ¬ì‹œì•ˆë¸”ë£¨.png',
            'siamese': 'ìƒ´.png',
            'munchkin': 'ë¨¼ì¹˜í‚¨.png',
            'maincoon': 'ë©”ì¸ì¿¤.png',
            'ragdoll': 'ë ‰ëŒ.png'
        };

        function createSlot(type) {
            const cat = catData[type];
            const slot = document.createElement('div');

            if (cat.owned) {
                slot.className = 'cat-slot unlocked';
                slot.innerHTML = `<img src="${catImages[type]}" style="width: 145px; height: 145px; border-radius: 10px;">`;
            } else {
                slot.className = 'cat-slot locked';
                slot.innerHTML = `<div class="question">?</div><div class="unlock-text">UNLOCK</div>`;
            }

            return slot;
        }

        for (const type of leftBoxCats) {
            leftBox.appendChild(createSlot(type));
        }
        for (const type of rightBoxCats) {
            rightBox.appendChild(createSlot(type));
        }
    }

    function displayCat(type) {
        renderCatBoxes();
    }

    // ğŸ“ ë¸Œë¼ìš°ì €ì—ê²Œ 'bounce'ê°€ ë­”ì§€ ì•Œë ¤ì£¼ëŠ” ì„¤ëª…ì„œ (ì´ê²Œ ì—†ìœ¼ë©´ ì ˆëŒ€ ì•ˆ íŠ‘ë‹ˆë‹¤!)
    const bounceAnimation = document.createElement('style');
    bounceAnimation.innerHTML = `
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); } 
        }
    `;
    document.head.appendChild(bounceAnimation);
const styleTag = document.createElement('style');
styleTag.innerHTML = `
    @keyframes bounce {
        from { transform: translateY(0); }
        to { transform: translateY(-10px); } 
    }
`;
document.head.appendChild(styleTag);
   
   </script>
   

    <div id="shop">
    <div style="display: flex; gap: 10px; margin-bottom: 5px;">
        <button id="power-up-btn" onclick="upgradePower()">
            ğŸ“¢ ê±°ì§€ ì—…ê·¸ë ˆì´ë‘ (ê°€ê²©: <span id="upgrade-cost">50</span>ì›)
        </button>
        <button id="toggle-cat-btn" onclick="toggleCatList()">ğŸ¾ ì•Œë°”ìƒ ê³ ìš©í•˜ê¸°</button>
    </div>

    <div id="cat-list-container" class="cat-list">
        <button id="btn-korshort" onclick="buyCat('korshort')"></button>
        <button id="btn-persian" onclick="buyCat('persian')"></button>
        <button id="btn-russian" onclick="buyCat('russian')"></button>
        <button id="btn-siamese" onclick="buyCat('siamese')"></button>
        <button id="btn-munchkin" onclick="buyCat('munchkin')"></button>
        <button id="btn-maincoon" onclick="buyCat('maincoon')"></button>
        <button id="btn-ragdoll" onclick="buyCat('ragdoll')"></button>
  </div> </div> </body>
</html>